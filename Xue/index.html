<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="description" content="">
    <meta name="keywords" content="">
    <meta name="viewport"
          content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="renderer" content="webkit">
    <title>Xue</title>

</head>
<body id="page">

<div>{{name}}</div>
<p>{{age}}</p>



</body>

<script src="vue.min.js"></script>

<script>

    var v = new Vue({
        el: 'body',
        data: {
            person: {
                name: 1
            }
        }
    })

     function Lue(opts) {
         this.$data = {}

         if (typeof opts.data === 'object') {
             // 需要将 opts.data 的数据绑定到 $data 上，所以目标对象为 $data，源对象为 opts.data
             this._each(this.$data, opts.data)
         }

         if (typeof opts.ready === 'function') {
             opts.ready.call(this)
         }
     }

     Lue.prototype = {
         constructor: Lue,

         /**
          * 遍历深层数据对象
          * @param aimObj 需要被绑定到的目标对象
          * @param sourceObj 源对象
          * @private
          */
         _each: function (aimObj, sourceObj) {
             var value
             for (var key in sourceObj) {
                 value = sourceObj[key]
                 // 当遍历到的属性值是个对象时，对该对象再次进行遍历，此时目标对象和源对象相同，不需要改变 value 上属性所绑定的对象
                 if (typeof value === 'object') {
                     this._each(value, value)
                 }
                 // 当该属性值不为对象时，进行数据绑定
                 this._bindData(aimObj, key, value)
             }
         },

         _bindData: function (obj, key, val) {
             var self = this
             Object.defineProperty(obj, key, {
                 enumerable: true, // 是否可枚举
                 configurable: true, // 是否可删除
                 get: function () {
                     console.log('get', key, val)
                     return val
                 },
                 set: function (newVal) {
                     console.log('set', key, newVal)
                     if (val !== newVal) val = newVal
                     // 设置属性为对象时执行 添加属性时并不会执行
                     if (typeof newVal == 'object') self._each(newVal, newVal)
                 }
             })
         }
     }

     var l = new Lue({
         data: {
             person: {
                 name: 'xiaohong',
                 age: 17
             }
         },
         ready: function () {
             console.log(this.$data.person.name)
             console.log(this.$data.person.age)
             this.$data.person.name = 'ligang'
             this.$data.person.age = 99

             this.$data.person.sex = 1
         }
     })



//    var sss = new Vue({
//        el: 'body',
//        methods: {
//            fun: function () {
//                alert('sss')
//            }
//        },
//        ready: function () {
//        }
//    })
    //    console.log(sss)

    function Xue (data) {
        this.$el = document.querySelector(data.el)
        this.$data
        this.$methods
        this.$directives = []



        if (typeof data === 'object') {
            this.$data = data.data
            this.$methods = data.methods
            this._walk(this.$data, data.data)
            this._converseFun()
            this._compileNode(this.$el)

            data.ready.call(this)
        }

    }

    Xue.prototype = {
        constructor: Xue,

        _walk: function (scope, data) {
            var val
            for (var key in data) {
                if (data.hasOwnProperty(key)) {
                    val = data[key]
                    if (typeof val === 'object') {
                        this._walk(val, val)
                    }
                    this._watch(scope, key, val)
                }
            }
        },

        _watch: function (scope, key, val) {
            Object.defineProperty(scope, key, {
                enumerable: true,
                configurable: true,
                get: function () {
                    console.log('get ' + key, val)
                    return val
                },
                set: function (newVal) {
                    console.log('set ' + key, newVal, val)
                    if (val !== newVal) val = newVal
                }
            })
        },

        _converseFun: function () {
            var key, val, self = this;
            for (key in this.$methods) {
                val = this.$methods[key]
                if (typeof val === 'function') {
                    this.$methods[key] = function (i) {
                        var length = arguments.length
                        length?
                                length > 1 ? val.apply(self, arguments) : val.call(self, i)
                                : val.call(self)
                    }
                }
            }
        },

        _compileNode: function (node) {
            switch (node.nodeType) {

                case 1:// node
                    this._compileElement(node)
                    break

                case 3 :// text
                    this._compileText(node)
                    break
                default:
                    return
            }
        },

        _compileElement: function (node) {
            if (node.hasChildNodes()) {
                Array.from(node.childNodes).forEach(this._compileNode, this)
            }
        },

        _compileText: function (node) {
            var patt = /{{\w+}}/g
            var nodeValue = node.nodeValue
            var expressions = nodeValue.match(patt) // 这是一个数组,形如["{{name}}"];

            if (!expressions) return

            var self = this
            expressions.forEach(function (expression) {
                var el = document.createTextNode('')
                node.parentNode.insertBefore(el, node)
                var property = expression.replace(/[{}]/g, '')
                self._bindDirective('text', property, el)
            })

            node.parentNode.removeChild(node);
        },

        _bindDirective: function (name, expression, node) {
            var dirs = this.$directives;
            dirs.push(
                    new Directive(name, node, this, expression)
            );
//            console.log(dirs)
        }



    }

    function Directive(name, el, vm, expression) {
        this.name = name
        this.el = el
        this.vm = vm
        this.expression = expression
        this.attr = 'nodeValue'

        this.update()
    }

    Directive.prototype.update = function () {
//        console.log(this.vm)
        this.el[this.attr] = this.vm.$data[this.expression]
//        console.log(`更新了DOM-${this.expression}`)
    };


    var test = new Xue ({
        el: 'body',
        data: {
            tom: {
                name: 'Troy',
                age: '24'
            }
        },
        methods: {
            addAttr: function (name) {
//                console.log(name)
//                this.$data.name = name
            }
        },
        ready: function () {
            this.$methods.addAttr('Xiaoming')
        }

    })

//    console.log(test)


</script>
</html>